<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fjellruta – testvisning</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: sans-serif; background: #f2f2f2; }
    h2 { text-align: center; margin: 20px; }
    #map { height: 50vh; }
    .chart-wrapper {
      position: relative;
      height: 30vh;
      margin: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    canvas {
      position: absolute;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>

<h2>Fjellruta – testvisning</h2>

<div id="map"></div>

<div class="chart-wrapper">
  <canvas id="elevationChart"></canvas>
</div>

<!-- JS Libraries -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.4.0/gpx.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>

<script>
  // 1. Sett opp Leaflet-kart
  const map = L.map('map').setView([60.25, 8.85], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Kartdata © OpenStreetMap',
    maxZoom: 19
  }).addTo(map);

  // 2. Legg til rute (GPX-spor)
  new L.GPX('https://raw.githubusercontent.com/sihoe/svingom-fjellruta/main/Fjellruta_over_Vegglifjell_og_Imingfjell.gpx', {
    async: true,
    polyline_options: {
      color: '#37394E',
      weight: 5,
      opacity: 0.9
    },
    marker_options: {
      startIconUrl: null,
      endIconUrl: null,
      shadowUrl: null,
      wptIconUrls: { '': null }
    }
  }).on('loaded', function(e) {
    map.fitBounds(e.target.getBounds(), { padding: [20, 20] });
  }).addTo(map);

  // 3. Last inn og tegn høydeprofil
  async function loadElevationData() {
    const res = await fetch("https://raw.githubusercontent.com/sihoe/svingom-fjellruta/main/fjellruta_elevation.json");
    const data = await res.json();

    const route = data.filter(d => d.elevation !== null);
    const distances = route.map(d => parseFloat(d.distance));
    const elevations = route.map(d => parseFloat(d.elevation));

    new Chart(document.getElementById("elevationChart").getContext("2d"), {
      type: 'line',
      data: {
        labels: distances,
        datasets: [
          {
            data: elevations,
            borderColor: "#37394E",
            borderWidth: 3,
            pointRadius: 0,
            tension: 0.4,
            fill: true,
            backgroundColor: "rgba(55, 57, 78, 0.2)"
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: {
            type: 'linear',
            ticks: { callback: v => `${v.toFixed(0)} km` },
            title: { display: false },
            grid: { display: false }
          },
          y: {
            ticks: { stepSize: 100 },
            title: { display: false },
            grid: { display: false }
          }
        }
      }
    });
  }

  loadElevationData();

  // 4. Legg til POI-markører fra JSON
  fetch("https://raw.githubusercontent.com/sihoe/svingom-fjellruta/main/fjellruta_poi.json")
    .then(res => res.json())
    .then(pois => {
      pois.forEach(poi => {
        L.marker([poi.lat, poi.lon])
          .addTo(map)
          .bindPopup(`<strong>${poi.name}</strong><br>${poi.desc}`);
      });
    });
</script>

</body>
</html>
